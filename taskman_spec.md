
# Taskman 仕様書

## 1. 概要

**Taskman** は、Streamlitベースで構築されたシンプルな **カンバン式タスク管理アプリケーション** 。SQLiteデータベースを用いてタスクの情報を永続的に保存し、Webブラウザ上でタスクの追加、編集、削除、ステータス変更、並び替え、検索、フィルタリングが可能。

## 2. 必要なライブラリおよび開発環境

このアプリケーションを正しく実行するには、以下のPythonライブラリが必要。
事前にPython3.8以上がインストールされた環境で、以下のコマンドを実行して必要なライブラリをインストールすること。

### 2.1 使用ライブラリ一覧

| ライブラリ名 | バージョン指定 | 用途                           |
| ------------ | -------------- | ------------------------------ |
| streamlit    | 任意           | メインUIの構築                 |
| pandas       | 任意           | データの整形・操作             |
| sqlite3      | 標準ライブラリ | データベースとの接続・操作     |
| pathlib      | 標準ライブラリ | ファイル操作（パス処理）       |
| datetime     | 標準ライブラリ | 日付・時間の処理               |
| os           | 標準ライブラリ | ファイルの保存や存在確認処理等 |

### 2.2 推奨インストール手順

venvを使った仮想環境での実行を推奨する。

```bash
python -m venv venv

venv\Script\Activate
```

```bash
pip install streamlit pandas
```

## 3. 主な機能一覧

| 機能名                 | 内容                                                       |
| ---------------------- | ---------------------------------------------------------- |
| タスクの追加・削除     | タイトル・詳細・期日・優先度・タグ・添付ファイルを指定可能 |
| ステータス別表示       | `Todo` / `Doing` / `Done` カラムによるカンバン表示         |
| 並び替え               | 期日順・優先度順での並び替え（サイドバーで切り替え）       |
| 折畳み・展開状態の保持 | セッション状態ごとに保存された展開/折畳状態を反映          |
| 添付ファイル           | PDF/JPG/PNGなどをアップロードし、ダウンロードリンク表示    |
| DB切り替え             | 同一フォルダー内の SQLite ファイルを選択可能、新規作成可能 |
| フィルター             | タグ、優先度によるチケットの絞り込み                       |
| ソート                 | カードの上下移動による並び順変更                           |
| セーフティチェック     | `unsafe_allow_html=True` による HTML描画に注意喚起あり     |

## 4. データベース仕様（SQLite）

### 4.1 テーブル名: `tickets`

| カラム名     | 型        | 説明                                 |
| ------------ | --------- | ------------------------------------ |
| `id`         | INTEGER   | プライマリキー（自動インクリメント） |
| `title`      | TEXT      | タスクタイトル（必須）               |
| `detail`     | TEXT      | タスク詳細（複数行対応）             |
| `due`        | DATE      | 期日（任意）                         |
| `priority`   | TEXT      | 優先度（High / Medium / Low）        |
| `status`     | TEXT      | ステータス（Todo / Doing / Done）    |
| `tags`       | TEXT      | タグ（カンマ区切り）                 |
| `sort`       | INTEGER   | カードの並び順制御                   |
| `created`    | TIMESTAMP | 登録日時                             |
| `updated`    | TIMESTAMP | 最終更新日時                         |
| `parent_id`  | INTEGER   | 親タスクID（サブタスク用）           |
| `attachment` | TEXT      | 添付ファイルのファイルパス           |

## 5. システム構成

- **フロントエンド**: [Streamlit](https://streamlit.io/)
- **データベース**: SQLite3
- **UI操作**:
  - `st.form` によるタスク追加
  - `st.expander` による詳細の開閉式カード
  - `st.sidebar` によるソート・フィルタオプション設定

## 6. ファイル構成と起動方法

```　bash
.
├── app.py                 # メインアプリケーション
├── tickets.db             # SQLiteデータベース（複数切替対応）
├── uploads/               # 添付ファイル保存用ディレクトリ
```

### 6.1. 起動方法

``` bash
streamlit run app.py
```

### 6.2. 実行可能ファイルへのコンバート方法

``` bash
streamlit-desktop-app build app.py --name Taskman --pyinstaller-options --windowed --onefile
```

## 7. セキュリティと制約事項

- `unsafe_allow_html=True` を使用しているため、**XSSリスクのあるHTMLの描画に注意が必要**。
- ファイルアップロード時は `uploads/` ディレクトリに保存され、任意のファイル名が保存可能なため、**ファイル名の検証などの対策は未実装**。

## 8. 既知の不具合

### 8.1. チケットの展開/折畳情報が保持されない

  起動のたびにチケットが折り畳まれて表示される。SQLの情報に展開情報を追加することで次回起動時にも対応できるようにしたい。

### 8.2. 展開したチケットを横移動させると、そのチケットより後ろにあるチケットが展開される

　展開/折畳情報を管理する方法がまずい。展開/折畳情報の管理方法の検討が必要。

### 8.3. チケットに添付するファイル名が重複したとき、チケットが編集不可になる

　何が起こってるんこれ。（とりあえず同じファイルをアップしたチケットを消すと動作が戻る）

## 9. 今後の拡張構想

- サブタスクの階層表示対応
- チケットコメント機能の追加
- 期日のカスタムカレンダー対応（祝日/休日表示）
- 担当者割当・ユーザー管理機能
- モバイル対応のUI最適化
- タグ色・優先度に応じた色変更のスタイル強化

## 10. 機能拡張方針

このセクションでは、本アプリケーションに対して今後機能拡張を行うための基本方針および具体的な拡張例について示す。

### 10.1. 拡張設計の基本方針

本アプリケーションは以下の設計方針に基づいて機能が構成されている:

- **状態管理**: Streamlitの`st.session_state`により、UI状態（編集中フラグ・展開状態など）を保持
- **データ保存**: SQLiteを使用し、ローカルファイル`tickets.db`にタスク情報を保存
- **動的UI**: Streamlitを利用し、リアクティブなカードベースのUIを構築

拡張機能は、主に以下のレイヤーで実施可能。

| レイヤー     | 役割                           | 主な修正ファイル     |
| ------------ | ------------------------------ | -------------------- |
| UI           | 入力フォーム、チケットの表示   | `app.py` (Streamlit) |
| データ構造   | テーブル構造、DB操作           | `app.py` / SQLite    |
| 状態管理     | ユーザ操作に応じた状態更新処理 | `st.session_state`   |
| ファイル構成 | アップロード・ダウンロード処理 | `os` / `uploads/`    |

### 10.2. 機能追加例

#### 10.2.1. サブタスク機能の追加

**概要**: タスクに階層構造（親子関係）をもたせ、タスクの内報関係を表現

**変更点**:

- DBに`parent_id` カラムを追加（対応済み）
- `insert_ticket()` 実行時に `parent_id`を渡す処理を追加
- UI上で子タスクの展開・折畳や並び変え機能を拡張

#### 10.2.2 ファイル添付機能の拡張

**概要**：複数ファイルの添付、ダウンロードリンク表示

**変更点**：

- DB構造を `attachment` から複数ファイル管理に変更（別テーブルを推奨）
- ファイル保存ディレクトリを `uploads/{ticket_id}/` に分離管理
- 表示部分で複数ファイルを `st.download_button()` でループ処理

#### 10.2.3 カレンダー表示の拡張

**概要**：会社の休業日や祝日を反映したカスタムカレンダー表示

**実装方法**：

- `holidays` ライブラリを使って日本の祝日を取得
- 独自休日はCSVまたは .icsファイルで管理・読み込み
- カレンダー描画に `plotly`, `streamlit-aggrid`, `matplotlib` 等を検討

---
